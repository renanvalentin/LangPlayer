/*
	name		: bubbles.js
	description	: Adds Captions and Subtitles support to HTML5 video
	url		: bubbles.childnodes.com
	Version	: 1.0 ( 20 / 8 / 2011 )
	____________________________________________________
	Copyright (C) 2011,  Pantelis Kalogiros

	You may use this project under the terms of the MIT License 
	please see http://www.opensource.org/licenses/mit-license.html
*/
function videoBubbles(){var c=this,h=document;this.all={};this.subs={};this.effects={};this.wrapObject=function(c,a,b){var a=h.createElement("div"),f=c.nextSibling,e=f.parentNode,i=c.cloneNode(!0);a.className="bubblesContainer "+b;a.style.cssText="width:"+c.width+"px;height:"+c.height+"px";a.appendChild(i);e.insertBefore(a,f);e.removeChild(c);return a};this.subtitleSHOW=function(c,a,b){c.innerHTML=b?a:""};this.subsLangSelect=function(d,a,b){this.subsSelectData={obj:d,id:a,template:b};var f=h.getElementById(a);
this.subsPrepare=function(e){var a="",e=b.replace("####",e);a+=e;f.innerHTML+=a;a=f.childNodes;for(e=a.length;e-- >0;)a[e].addEventListener("click",function(){var e=this.textContent;c.subs[d.id].lang=e;c.subs[d.id].showing&&c.subtitleSHOW(c.subs[d.id].subCont,c.subs[d.id][e][c.subs[d.id].active].text,!0)},!1)}};this.close=function(d,a){var b=c.all[a][d];c.effects.fade(b.object,b.data,!1);b.data.callbackEnd&&b.data.callbackEnd()};this.add=function(d){var a=d[1],b;a.className="bubl "+a.className;switch(a.type){case "link":b=
h.createElement("a");b.href=a.content;break;case "content":b=h.createElement("div"),b.innerHTML=a.content+'<a class="close" onClick="Bubbles.close(\''+d[0]+"','"+this.id+"');\">X</a>"}var f=b.style,e=a.dimensions,i=a.position;if(e.length>0)f.width=e[0],f.height=e[1];f.top=i[0];f.left=i[1];b.className=a.className;this.container.appendChild(b);if(typeof a.effect==="string")a.effect=[a.effect,a.effect];c.all[this.id][d[0]]={data:a,object:b,flag:!1}};this.remove=function(d){c.all[this.id][d].object.parentNode.removeChild(c.all[this.id][d].object);
delete c.all[this.id][d]};this.interval=function(){c.timeout=setInterval(function(){for(var d in c.all)for(var a in c.all[d]){var b=c.all[d][a],f=h.getElementById(d),e=b.curTime,i=f.currentTime,k=b.data.config,l=k.length;if(i!==e){b.curTime=i;for(var g=0;g<l;){if(!k[g+1])k[g+1]=f.duration;if(i>k[g]&&i<k[g+1]){if(!b.flag)b.flag=!0;break}else if(b.flag)b.flag=!1;g+=2}if(b.flag){if(b.edit)c.effects[b.data.effect[0]](b.object,b.data,!0),b.data.callback&&b.data.callback(),b.edit=!1}else if(!b.edit)b.edit=
!0,c.effects[b.data.effect[1]](b.object,b.data,!1),b.data.callbackEnd&&b.data.callbackEnd()}}for(d in c.subs){a=c.subs[d];b=a.lang;if(!a[b])return 0;f=a[b].length;k=a.subCont;e=a[b].curTime;i=h.getElementById(d).currentTime+a.syncNumber;if(i!==e)if(g=a.active,a[b].curTime=i,e<i){if(!(a[b][g].end>i&&a.showing)){for(e=g;e<f;e++)if(!c.subtitleLoop(a,i,e,b,k))break;for(e=0;e<g;e++)if(!c.subtitleLoop(a,i,e,b,k))break}}else if(e>i)for(;g>=0;g--)if(!c.subtitleLoop(a,i,g,b,k))break}},340);this.subtitleLoop=
function(d,a,b,f,e){var f=d[f][b],i=f.end;if(a>f.start&&a<i){if(d.active!==b||d.showing===!1)d.active=b,c.subtitleSHOW(e,f.text,!0),d.showing=!0;return!1}else if(d.active===b)c.subtitleSHOW(e,f.text,!1),d.showing=!1;return!0}};this.interval();this.videoJS=function(d,a,b){return new c.video(d,a,b,!0)};this.video=function(d,a,b,f){this.id=d;this.el=h.getElementById(d);this.add=function(e){for(var a in e)c.add.call(this,[a,e[a]])};this.remove=function(e){c.remove.call(this,e)};this.jump=function(e,a){this.el.currentTime=
a===!0||a==="%"?this.el.duration/100*e:e};this.subsLanguageSelect=function(a,b){c.subsLangSelect(this.obj,a,b)};this.subsSync=function(a){c.subs[this.id].syncNumber=a*-1};this.subsToggle=function(){var a=c.subs[this.id].subCont.style;a.display=a.display=="none"?"block":"none"};this.subsShow=function(a){subContStyle.display=a?"block":"none"};this.langChange=function(a){c.subs[this.id].lang=a;c.subs[this.id].showing&&c.subtitleSHOW(c.subs[this.id].subCont,c.subs[this.id][a][c.subs[this.id].active].text,
!0)};this.subtitles=function(a,b,d){this.request=a===1?"http://isqueel.com/bubbles/jsonsrt.php":a;if(!d)for(var f in b){d=f;break}a=h.createElement("div");this.el.parentNode.appendChild(a);this.el.parentNode.style.overflow="visible";a.className="subtitles";a.id=this.id+"_subs";c.subs[this.id]={lang:d,subCont:document.getElementById(this.id+"_subs"),active:0,showing:!1,syncNumber:0};for(var g in b)this.subsAdd(g,b[g])};this.subsAdd=function(a,b){if(this.request){var c=new XMLHttpRequest,d="url="+b.file,
g=this;c.open("POST",this.request,!0);c.setRequestHeader("Content-type","application/x-www-form-urlencoded");c.onreadystatechange=function(){c.readyState==4&&c.status==200&&g.subsReady(eval(c.responseText),a)};c.send(d)}else c=new XMLHttpRequest,g=this,c.open("GET",b.file,!0),c.onreadystatechange=function(){c.readyState==4&&c.status==200&&g.subsReady(g.subsParser(c.responseText),a)},c.send()};this.subsReady=function(a,b){c.subs[this.id][b]=a;c.subsPrepare&&c.subsPrepare(b)};this.toSecs=function(a){var c=
0;if(a)for(var a=a.split(":"),b=0,d=a.length;b<d;b++)c=c*60+parseFloat(a[b].replace(",","."));return c};this.subsParser=function(a){for(var a=a.split("\n"),c=a.length-1,b=[],d=0,g=0,f,h="",j=0;j<c;j++)if(f=a[j].replace(/^\s+|\s+$/g,""),!isNaN(f)&&parseInt(a[j])===d+1){++g;d=parseInt(a[j]);b[g]=[];f=a[++j].split("--\>");b[g].start=this.toSecs(f[0]);b[g].end=this.toSecs(f[1]);b[g].text="";for(f=0;a[j+ ++f].replace(/^\s+|\s+$/g,"")!=="";)b[g].text+=a[j+f].replace(/\n\r|\r\n|\n|\r/g,"<br />")}f=b.length;
h=[];for(j=1;j<f;j++)h[j-1]={start:b[j].start,end:b[j].end,text:b[j].text};return h};if(!a||typeof a!=="string")b=a,a=d;c.all[d]={};f?(this.container=this.el.parentNode,this.container.className+=" "+a):this.container=c.wrapObject(this.el,d,a);this.el=h.getElementById(this.id);this.add(b)}}var Bubbles=new videoBubbles;Bubbles.effects["default"]=function(c,h,d){c.style.display=d?"block":"none"};
Bubbles.effects.slide=function(c,h,d){if(d){var a=c.style,b=a.top;a.top="-1024px";a.display="block";setTimeout(function(){c.className=h.className+" topTransition";a.top=b},48)}else a=c.style,b=a.top,c.className=h.className+" topTransition",setTimeout(function(){a.display="none";a.top=h.position[0];c.className=h.className},340),a.top="1248px"};
Bubbles.effects.fade=function(c,h,d){if(d){var a=c.style;a.opacity=0;a.display="block";setTimeout(function(){c.className=h.className+" fadeIn";a.opacity=""},48)}else a=c.style,setTimeout(function(){a.display="none";c.className=h.className},340),c.className=h.className+" fadeOut"};